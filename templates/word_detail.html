{% extends "base.html" %}

{% block title %}{{ word.term }} - Vocabulary Explorer{% endblock %}

{% block content %}
<div class="container mt-4">
    {% if is_random %}
    <div class="alert alert-success">
        üé≤ <strong>Random Discovery!</strong> Here's a word to explore.
        <a href="/random" class="btn btn-sm btn-outline-success ms-2">Another Random Word</a>
    </div>
    {% endif %}
    
    <div class="row">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h1 class="display-4 mb-2">{{ word.term }}</h1>
                            {% if word.part_of_speech %}
                            <span class="badge bg-secondary fs-6">{{ word.part_of_speech }}</span>
                            {% endif %}
                            
                            <!-- Pronunciation Section -->
                            {% if word.ipa_transcription or word.arpabet_transcription %}
                            <div class="mt-3">
                                <div class="d-flex align-items-center flex-wrap gap-2">
                                    <!-- Always show pronunciation button -->
                                    {% if word.wav_url %}
                                    <button id="pronunciation-btn" class="btn btn-outline-primary btn-sm" onclick="playPronunciation()">
                                        <span id="play-icon">üîä</span> Play Pronunciation
                                    </button>
                                    <audio id="pronunciation-audio" preload="none" style="display: none;">
                                        <source src="{{ word.wav_url }}" type="audio/wav">
                                        Your browser does not support the audio element.
                                    </audio>
                                    {% else %}
                                    <button id="pronunciation-btn" class="btn btn-outline-secondary btn-sm" disabled>
                                        <span id="play-icon">üîá</span> Pronunciation Unavailable
                                    </button>
                                    {% endif %}
                                    
                                    {% if word.ipa_transcription %}
                                    <span class="badge bg-info text-dark fs-6" title="IPA Transcription">
                                        /{{ word.ipa_transcription }}/
                                    </span>
                                    {% endif %}
                                    
                                    {% if word.syllable_count %}
                                    <span class="badge bg-light text-dark fs-6" title="Syllables">
                                        {{ word.syllable_count }} syllable{{ word.syllable_count != 1 and 's' or '' }}
                                    </span>
                                    {% endif %}
                                </div>
                                
                                {% if word.arpabet_transcription %}
                                <div class="mt-2">
                                    <small class="text-muted" title="ARPAbet Transcription">
                                        ARPAbet: {{ word.arpabet_transcription }}
                                    </small>
                                </div>
                                {% endif %}
                                
                                {% if word.stress_pattern %}
                                <div class="mt-1">
                                    <small class="text-muted" title="Stress Pattern">
                                        Stress: {{ word.stress_pattern }}
                                    </small>
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="text-end">
                            {% if word.frequency_rank %}
                            <div class="badge bg-info fs-6 mb-1">
                                Rank: {{ "{:,}".format(word.frequency_rank) }}
                            </div>
                            <br>
                            {% endif %}
                            {% if word.rarity_percentile %}
                            <div class="badge bg-warning fs-6">
                                {{ "%.1f"|format(word.rarity_percentile) }}% rarity
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h5 class="text-muted mb-2">Definition</h5>
                        <p class="lead">{{ word.definition }}</p>
                    </div>
                    
                    <!-- Flashcard Actions for logged-in users -->
                    {% if current_user %}
                    <div class="mb-4">
                        <h6 class="text-muted mb-2">üìö Study Tools</h6>
                        <div class="d-flex gap-2 flex-wrap">
                            <div class="dropdown">
                                <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" id="addToFlashcards" data-bs-toggle="dropdown">
                                    ‚ûï Add to Flashcards
                                </button>
                                <ul class="dropdown-menu" id="flashcardDecks">
                                    <li><a class="dropdown-item" href="#" onclick="createNewDeckWithWord()">üìù Create New Deck</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li class="dropdown-item-text text-muted">Loading decks...</li>
                                </ul>
                            </div>
                            <button class="btn btn-outline-secondary btn-sm" onclick="practiceWord()">
                                üß† Quick Practice
                            </button>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if word.primary_domain or word.secondary_domain %}
                    <div class="mb-4">
                        <h6 class="text-muted mb-2">Domain Classification</h6>
                        {% if word.primary_domain %}
                        <span class="badge bg-success me-2">{{ word.primary_domain }}</span>
                        {% endif %}
                        {% if word.secondary_domain and word.secondary_domain != word.primary_domain %}
                        <span class="badge bg-outline-success">{{ word.secondary_domain }}</span>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    {% if word.frequency_rank or word.final_rarity %}
                    <div class="mb-4">
                        <h6 class="text-muted mb-2">Frequency & Rarity Analysis</h6>
                        <div class="row">
                            {% if word.frequency_rank %}
                            <div class="col-md-6">
                                <small class="text-muted">Frequency Ranking</small>
                                <div class="fw-bold">
                                    {{ "{:,}".format(word.frequency_rank) }} / 23,148
                                    {% if word.rarity_category %}
                                    <span class="badge bg-{% if word.rarity_category == 'common' %}success{% elif word.rarity_category == 'somewhat common' %}info{% elif word.rarity_category == 'somewhat rare' %}warning{% elif word.rarity_category == 'rare' %}orange{% else %}danger{% endif %} ms-2">
                                        {{ word.rarity_category }}
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                            {% if word.final_rarity %}
                            <div class="col-md-6">
                                <small class="text-muted">Raw Rarity Score</small>
                                <div class="fw-bold">{{ "%.4f"|format(word.final_rarity) }}</div>
                                <small class="text-muted">(0 = common, 1 = ultra-rare)</small>
                            </div>
                            {% endif %}
                        </div>
                        {% if word.rarity_percentile %}
                        <div class="mt-3">
                            <small class="text-muted">Rarity Level</small>
                            <div class="progress mt-1" style="height: 10px;">
                                <div class="progress-bar {% if word.rarity_percentile < 20 %}bg-success{% elif word.rarity_percentile < 40 %}bg-info{% elif word.rarity_percentile < 60 %}bg-warning{% elif word.rarity_percentile < 80 %}bg-orange{% else %}bg-danger{% endif %}" style="width: {{ word.rarity_percentile }}%"></div>
                            </div>
                            <small class="text-muted">{{ "%.1f"|format(100 - word.rarity_percentile) }}% of words are more common</small>
                        </div>
                        {% endif %}
                        {% if word.num_sources %}
                        <div class="mt-2">
                            <small class="text-muted">Data Quality: {{ word.num_sources }} frequency source{{ word.num_sources != 1 and 's' or '' }}</small>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="mt-4 text-center">
                <a href="/" class="btn btn-outline-primary me-2">‚Üê Back to Search</a>
                <a href="/random" class="btn btn-primary">üé≤ Random Word</a>
            </div>
        </div>
        
        <div class="col-lg-4">
            {% if similar_words %}
            <div class="similar-words">
                <h5 class="mb-3">
                    <span class="text-primary">üîó</span> Similar Words
                </h5>
                <div class="list-group list-group-flush">
                    {% for word_id, similar_word, similarity in similar_words %}
                    <div class="list-group-item border-0 px-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong><a href="/word/{{ word_id }}" class="text-decoration-none">{{ similar_word }}</a></strong>
                            <span class="badge bg-light text-dark">{{ "%.3f"|format(similarity) }}</span>
                        </div>
                        <small class="text-muted">{{ "%.1f"|format(similarity * 100) }}% similar</small>
                    </div>
                    {% endfor %}
                </div>
                <small class="text-muted mt-2 d-block">
                    Based on definition semantic similarity analysis
                </small>
            </div>
            {% endif %}
            
            <div class="mt-4">
                <div class="card border-0 bg-light">
                    <div class="card-body text-center">
                        <h6 class="card-title">Vocabulary Building</h6>
                        <p class="card-text small text-muted">
                            Practice and reinforce your vocabulary knowledge
                        </p>
                        <div class="d-flex gap-2 justify-content-center">
                            <a href="/quiz" class="btn btn-primary btn-sm">
                                <i class="fas fa-question-circle"></i> Take Quiz
                            </a>
                            <a href="/flashcards" class="btn btn-success btn-sm">
                                <i class="fas fa-layer-group"></i> Flashcards
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let isPlaying = false;

function playPronunciation() {
    const audio = document.getElementById('pronunciation-audio');
    const button = document.getElementById('pronunciation-btn');
    const icon = document.getElementById('play-icon');
    
    // Check if audio element exists and has a source (either src attribute or source child elements)
    const hasSource = audio && (audio.src || audio.querySelector('source'));
    if (!hasSource) {
        console.error('No audio source available');
        return;
    }
    
    if (isPlaying) {
        audio.pause();
        audio.currentTime = 0;
        isPlaying = false;
        icon.textContent = 'üîä';
        button.innerHTML = '<span id="play-icon">üîä</span> Play Pronunciation';
        button.classList.remove('btn-primary');
        button.classList.add('btn-outline-primary');
        return;
    }
    
    // Update UI to show loading/playing state
    icon.textContent = '‚è∏Ô∏è';
    button.innerHTML = '<span id="play-icon">‚è∏Ô∏è</span> Playing...';
    button.classList.remove('btn-outline-primary');
    button.classList.add('btn-primary');
    isPlaying = true;
    
    // Handle audio events
    audio.onloadstart = function() {
        console.log('Audio loading started');
    };
    
    audio.oncanplay = function() {
        console.log('Audio can start playing');
        audio.play().catch(error => {
            console.error('Audio play failed:', error);
            resetButton();
        });
    };
    
    audio.onended = function() {
        resetButton();
    };
    
    audio.onerror = function(e) {
        console.error('Audio error:', e);
        resetButton();
        alert('Sorry, the pronunciation audio could not be loaded. The audio file might be temporarily unavailable.');
    };
    
    // Start loading the audio
    audio.load();
    
    function resetButton() {
        isPlaying = false;
        const currentIcon = document.getElementById('play-icon');
        const currentButton = document.getElementById('pronunciation-btn');
        if (currentIcon && currentButton) {
            currentIcon.textContent = 'üîä';
            currentButton.innerHTML = '<span id="play-icon">üîä</span> Play Pronunciation';
            currentButton.classList.remove('btn-primary');
            currentButton.classList.add('btn-outline-primary');
        }
    }
}

// Keyboard shortcut: Press 'P' to play pronunciation
document.addEventListener('keydown', function(e) {
    if (e.key.toLowerCase() === 'p' && !e.ctrlKey && !e.altKey && !e.metaKey) {
        const activeElement = document.activeElement;
        // Only trigger if not typing in an input field
        if (activeElement.tagName !== 'INPUT' && activeElement.tagName !== 'TEXTAREA') {
            e.preventDefault();
            const audioElement = document.getElementById('pronunciation-audio');
            const hasSource = audioElement && (audioElement.src || audioElement.querySelector('source'));
            if (hasSource) {
                playPronunciation();
            }
        }
    }
});

// Flashcard functionality
{% if current_user %}
let userDecks = [];

// Load user's flashcard decks
async function loadFlashcardDecks() {
    try {
        const response = await fetch('/api/flashcards/decks', {
            method: 'GET'
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                userDecks = data.decks;
                updateFlashcardDropdown(data.decks);
            } else {
                updateFlashcardDropdown([]);
            }
        } else {
            updateFlashcardDropdown([]);
        }
    } catch (error) {
        console.error('Error loading flashcard decks:', error);
        updateFlashcardDropdown([]);
    }
}

function updateFlashcardDropdown(decks) {
    const dropdown = document.getElementById('flashcardDecks');
    const existingItems = dropdown.querySelectorAll('li:not(:first-child):not(:nth-child(2))');
    existingItems.forEach(item => item.remove());
    
    if (decks.length === 0) {
        const li = document.createElement('li');
        li.innerHTML = '<span class="dropdown-item-text text-muted">No decks yet. Create one above!</span>';
        dropdown.appendChild(li);
    } else {
        decks.forEach(deck => {
            const li = document.createElement('li');
            li.innerHTML = `<a class="dropdown-item" href="#" onclick="addWordToDeck(${deck.id})">${deck.name}</a>`;
            dropdown.appendChild(li);
        });
    }
}

async function addWordToDeck(deckId) {
    try {
        const response = await fetch(`/api/flashcards/decks/${deckId}/cards/{{ word.id }}`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Show success message
            showFlashcardMessage('‚úÖ Word added to flashcard deck!', 'success');
        } else {
            showFlashcardMessage('‚ùå Failed to add word to deck', 'error');
        }
    } catch (error) {
        console.error('Error adding word to deck:', error);
        showFlashcardMessage('‚ùå Error adding word to deck', 'error');
    }
}

function createNewDeckWithWord() {
    const deckName = prompt('Enter name for your new flashcard deck:');
    if (deckName && deckName.trim()) {
        createFlashcardDeck(deckName.trim(), '');
    }
}

async function createFlashcardDeck(name, description) {
    try {
        const formData = new FormData();
        formData.append('name', name);
        formData.append('description', description);
        
        const response = await fetch('/api/flashcards/decks', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Add word to the new deck
            await addWordToDeck(result.deck_id);
            showFlashcardMessage(`‚úÖ Created deck "${name}" and added word!`, 'success');
        } else {
            showFlashcardMessage('‚ùå Failed to create deck', 'error');
        }
    } catch (error) {
        console.error('Error creating deck:', error);
        showFlashcardMessage('‚ùå Error creating deck', 'error');
    }
}

function practiceWord() {
    // Simple practice mode - show/hide definition
    const definition = document.querySelector('.lead');
    const button = event.target;
    
    if (definition.style.display === 'none') {
        definition.style.display = 'block';
        button.textContent = 'üß† Quick Practice';
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-secondary');
    } else {
        definition.style.display = 'none';
        button.textContent = 'üëÅÔ∏è Show Definition';
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-success');
    }
}

function showFlashcardMessage(message, type) {
    // Create and show a toast message
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    
    document.body.appendChild(toast);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 3000);
}

// Load decks when the dropdown is opened
document.getElementById('addToFlashcards').addEventListener('click', loadFlashcardDecks);
{% endif %}
</script>
{% endblock %}
